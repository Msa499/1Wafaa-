<!DOCTYPE html>
<html lang="ar">
<head>
  <!-- ... (ابقى على كل جزء head كما هو بدون تغيير) ... -->
</head>
<body>
  <!-- ... (ابقى على كل جزء body كما هو بدون تغيير حتى script) ... -->

  <script>
    // ... (ابقى على جميع الدوال الأخرى كما هي بدون تغيير حتى دالة showEpisodes) ...

    function showEpisodes(seriesId) {
      const container = document.getElementById("episodesContainer");
      container.innerHTML = "<p style='text-align:center;'>⏳ جاري تحميل الحلقات...</p>";
      
      // تحديد المسار الصحيح بناءً على نوع المسلسل (عربي/أجنبي)
      let seriesPath = `series/arabe/${seriesId}`;
      
      // جلب بيانات المسلسل أولاً
      db.ref(seriesPath).once("value").then(seriesSnapshot => {
        const seriesData = seriesSnapshot.val();
        
        if (!seriesData) {
          // إذا لم يتم العثور على المسلسل في المسار العربي، نبحث في المسار الأجنبي
          seriesPath = `series/foreign/${seriesId}`;
          return db.ref(seriesPath).once("value");
        }
        return { val: () => seriesData }; // إرجاع البيانات الموجودة
      }).then(seriesSnapshot => {
        const seriesData = seriesSnapshot.val();
        
        if (!seriesData) {
          container.innerHTML = "<p style='text-align:center;'>🙁 لا توجد معلومات عن المسلسل.</p>";
          return;
        }
        
        // جلب الحلقات من المسار الصحيح
        return db.ref(`${seriesPath}/episodes`).once("value").then(episodesSnapshot => {
          const episodes = episodesSnapshot.val();
          container.innerHTML = `
            <div style="grid-column:1/-1; text-align:center; margin-bottom:20px;">
              <h2 style="color:#e91e63; margin-bottom:10px;">${seriesData.title}</h2>
              ${seriesData.image ? `<img src="${seriesData.image}" style="max-width:200px; border-radius:8px; margin:0 auto;">` : ''}
            </div>`;
          
          if (!episodes) {
            container.innerHTML += "<p style='text-align:center; grid-column:1/-1;'>🙁 لا توجد حلقات متاحة.</p>";
            return;
          }
          
          // عرض الحلقات
          Object.values(episodes).forEach(ep => {
            if (ep.video && ep.title) {
              container.innerHTML += `
                <div class="episode" onclick="openInPlayer('${ep.video}')">
                  ${ep.image ? `<img src="${ep.image}" alt="${ep.title}">` : '<div style="height:180px;background:#333;display:flex;align-items:center;justify-content:center;">🎬</div>'}
                  <p>${ep.title}</p>
                </div>`;
            }
          });
          
          document.getElementById("seriesPopup").style.display = "flex";
        });
      }).catch(error => {
        console.error("Error loading episodes:", error);
        container.innerHTML = "<p style='text-align:center;color:red;grid-column:1/-1;'>❌ حدث خطأ أثناء تحميل الحلقات</p>";
      });
    }

    // ... (ابقى على بقية الدوال كما هي بدون تغيير) ...

    function openInPlayer(url) {
      const popup = document.getElementById("videoPopup");
      const video = document.getElementById("videoPlayer");
      const downloadBtn = document.getElementById("downloadBtn");
      
      if (url.includes('.m3u8')) {
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          hls.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play();
          });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
          video.addEventListener('loadedmetadata', function() {
            video.play();
          });
        }
      } else {
        video.src = url;
      }
      
      downloadBtn.href = url;
      downloadBtn.download = url.split('/').pop() || 'video.mp4';
      popup.style.display = "flex";
    }

    function closeVideo() {
      const video = document.getElementById("videoPlayer");
      video.pause();
      video.src = "";
      document.getElementById("videoPopup").style.display = "none";
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.innerText = message;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, 3000);
    }
  </script>
</body>
</html>
